@page "/produtos"
@attribute [Authorize(Roles = "Admin,Gestor")]
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entity
@using GestaoLoja.Entity.Enums

@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Produtos</PageTitle>

<h1>Produtos</h1>

<p>
    <a href="/produtos/create">Create New</a>
</p>

<div class="mb-3" style="display:flex; gap: 1rem; flex-wrap: wrap;">
    <div>
        <label class="form-label">Categoria</label>
        <select class="form-select" @bind="filtroCategoriaId">
            <option value="">(todas)</option>
            @foreach (var c in categorias)
            {
                <option value="@c.Id">@c.Nome</option>
            }
        </select>
    </div>

    <div>
        <label class="form-label">Estado</label>
        <select class="form-select" @bind="filtroEstado">
            <option value="">(todos)</option>
            @foreach (var e in Enum.GetValues<ProdutoEstado>())
            {
                <option value="@e">@e</option>
            }
        </select>
    </div>

    <div style="align-self:end;">
        <button class="btn btn-primary" @onclick="Recarregar">Apply</button>
        <button class="btn btn-secondary ms-2" @onclick="LimparFiltros">Clear</button>
    </div>
</div>

<QuickGrid TGridItem="ProdutoRow"
           Class="table"
           ItemsProvider="LoadProdutos"
           Pagination="pagination">

    <TemplateColumn Title="Imagem" Context="p">
        @if (!string.IsNullOrWhiteSpace(p.ImagemDataUrl))
        {
            <img class="img-thumbnail"
                 src="@p.ImagemDataUrl"
                 style="width:64px; height:64px; object-fit:cover;" />
        }
        else
        {
            <span>—</span>
        }
    </TemplateColumn>

    <PropertyColumn Property="p => p.Nome" />
    <PropertyColumn Property="p => p.Detalhe" />
    <PropertyColumn Property="p => p.PrecoBase" />
    <PropertyColumn Property="p => p.PrecoFinal" />
    <PropertyColumn Property="p => p.Estado" />
    <PropertyColumn Property="p => p.EmStock" />

    <PropertyColumn Property="p => p.CategoriaNome" Title="Categoria" />
    <PropertyColumn Property="p => p.FornecedorNome" Title="Fornecedor" />

    <TemplateColumn Title="Ações" Context="p">
        <a href="@($"/produtos/edit?id={p.Id}")">Edit</a> |
        <a href="@($"/produtos/details?id={p.Id}")">Details</a> |
        <a href="@($"/produtos/delete?id={p.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

<Paginator State="pagination" />

@code {
    private List<Categoria> categorias = new();

    private int? filtroCategoriaId;
    private ProdutoEstado? filtroEstado;

    private readonly PaginationState pagination = new() { ItemsPerPage = 10 };

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        categorias = await db.Categorias
            .AsNoTracking()
            .OrderBy(c => c.Ordem ?? int.MaxValue)
            .ThenBy(c => c.Nome)
            .ToListAsync();
    }

    private async ValueTask<GridItemsProviderResult<ProdutoRow>> LoadProdutos(GridItemsProviderRequest<ProdutoRow> request)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var q = db.Produtos
            .AsNoTracking()
            .AsQueryable();

        if (filtroCategoriaId.HasValue)
            q = q.Where(p => p.CategoriaProdutos.Any(c => c.Id == filtroCategoriaId.Value));

        if (filtroEstado.HasValue)
            q = q.Where(p => p.Estado == filtroEstado.Value);

        var total = await q.CountAsync();

        var pageSize = request.Count ?? pagination.ItemsPerPage;

        var produtos = await q
            .OrderByDescending(p => p.Id)
            .Skip(request.StartIndex)
            .Take(pageSize)
            .Include(p => p.CategoriaProdutos)
            .ToListAsync();

        var items = produtos.Select(p => new ProdutoRow
        {
            Id = p.Id,
            Nome = p.Nome,
            Detalhe = p.Detalhe,
            PrecoBase = p.PrecoBase,
            PrecoFinal = p.PrecoFinal,
            Estado = p.Estado,
            EmStock = p.Stock,
            FornecedorId = p.FornecedorId,
            CategoriaNome = BuildCategoriaNome(p.CategoriaProdutos),
            Imagem = p.Imagem,
            UrlImagem = p.UrlImagem
        }).ToList();

        var fornecedorIds = items
            .Select(p => p.FornecedorId)
            .Where(id => !string.IsNullOrWhiteSpace(id))
            .Distinct()
            .ToList();

        var fornecedores = await db.Users
            .AsNoTracking()
            .Where(u => fornecedorIds.Contains(u.Id))
            .ToListAsync();

        var fornecedorLookup = fornecedores.ToDictionary(u => u.Id, u => BuildUserDisplay(u, u.Id));

        // Build the data URL after materializing (keeps query clean)
        foreach (var row in items)
        {
            if (row.Imagem is { Length: > 0 } && !IsPlaceholderImage(row.Imagem))
            {
                var mime = GuessMime(row.Imagem);
                row.ImagemDataUrl = $"data:{mime};base64,{Convert.ToBase64String(row.Imagem)}";
            }
            else if (BuildImageUrl(row.UrlImagem) is { } imageUrl)
            {
                row.ImagemDataUrl = imageUrl;
            }
            else if (row.Imagem is { Length: > 0 })
            {
                var mime = GuessMime(row.Imagem);
                row.ImagemDataUrl = $"data:{mime};base64,{Convert.ToBase64String(row.Imagem)}";
            }
            else if (!string.IsNullOrWhiteSpace(row.UrlImagem))
            {
                row.ImagemDataUrl = row.UrlImagem;
            }

            row.FornecedorNome = row.FornecedorId is not null && fornecedorLookup.TryGetValue(row.FornecedorId, out var nome)
                ? nome
                : BuildUserDisplay(null, row.FornecedorId);
        }

        return GridItemsProviderResult.From(items, total);
    }

    private void Recarregar()
    {
        _ = pagination.SetCurrentPageIndexAsync(0);
    }

    private void LimparFiltros()
    {
        filtroCategoriaId = null;
        filtroEstado = null;
        _ = pagination.SetCurrentPageIndexAsync(0);
    }

    private static string GuessMime(byte[] bytes)
    {
        // JPEG: FF D8
        if (bytes.Length >= 2 && bytes[0] == 0xFF && bytes[1] == 0xD8)
            return "image/jpeg";

        // PNG: 89 50 4E 47
        if (bytes.Length >= 4 && bytes[0] == 0x89 && bytes[1] == 0x50 && bytes[2] == 0x4E && bytes[3] == 0x47)
            return "image/png";

        // GIF: 47 49 46
        if (bytes.Length >= 3 && bytes[0] == 0x47 && bytes[1] == 0x49 && bytes[2] == 0x46)
            return "image/gif";

        return "application/octet-stream";
    }

    private sealed class ProdutoRow
    {
        public int Id { get; set; }
        public string? Nome { get; set; }
        public string? Detalhe { get; set; }
        public decimal PrecoBase { get; set; }
        public decimal? PrecoFinal { get; set; }
        public ProdutoEstado Estado { get; set; }
        public int EmStock { get; set; }
        public string? FornecedorId { get; set; }
        public string? FornecedorNome { get; set; }

        public string? CategoriaNome { get; set; }

        // internal-only for building the preview
        public byte[]? Imagem { get; set; }
        public string? UrlImagem { get; set; }

        // what the UI uses
        public string? ImagemDataUrl { get; set; }
    }

    private static string BuildUserDisplay(ApplicationUser? user, string? fallbackId)
    {
        if (user is not null)
        {
            var fullName = $"{user.Nome} {user.Apelido}".Trim();
            if (!string.IsNullOrWhiteSpace(fullName))
                return fullName;

            if (!string.IsNullOrWhiteSpace(user.Email))
                return user.Email;
        }

        return string.IsNullOrWhiteSpace(fallbackId) ? "—" : fallbackId;
    }

    private static string? BuildImageUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return null;

        if (Uri.TryCreate(url, UriKind.Absolute, out _))
            return url;

        if (url.StartsWith("/"))
            return url;

        return $"/imgs/{Uri.EscapeDataString(url)}";
    }

    private static readonly byte[] PlaceholderImage = Convert.FromBase64String(
        "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=");

    private static bool IsPlaceholderImage(byte[] bytes)
        => bytes.Length == PlaceholderImage.Length && bytes.AsSpan().SequenceEqual(PlaceholderImage);

    private static string BuildCategoriaNome(ICollection<Categoria> categorias)
    {
        var nomes = categorias
            .Select(c => c.Nome)
            .Where(nome => !string.IsNullOrWhiteSpace(nome))
            .ToList();

        return nomes.Count > 0 ? string.Join(", ", nomes) : "—";
    }
}

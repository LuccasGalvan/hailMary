@page "/produtos/create"
@attribute [Authorize(Roles = "Admin,Gestor")]

@using System.IO
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entity
@using GestaoLoja.Entity.Enums

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Env

<PageTitle>Criar Produto</PageTitle>

<h1>Criar Produto</h1>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}

<EditForm method="post" Model="Produto" OnValidSubmit="AddProduto" FormName="create" Enhance>
    <DataAnnotationsValidator />
    <ValidationSummary class="text-danger" />

    <div class="mb-3">
        <label class="form-label">Fornecedor</label>
        <InputSelect class="form-select" @bind-Value="Produto.FornecedorId">
            <option value="">-- Selecionar fornecedor --</option>
            @foreach (var f in fornecedores)
            {
                <option value="@f.Id">@($"{f.Nome} {f.Apelido} ({f.Email})")</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Produto.FornecedorId" class="text-danger" />
    </div>

    <div class="mb-3">
        <label class="form-label">Nome</label>
        <InputText class="form-control" @bind-Value="Produto.Nome" />
        <ValidationMessage For="() => Produto.Nome" class="text-danger" />
    </div>

    <div class="mb-3">
        <label class="form-label">Detalhe</label>
        <InputText class="form-control" @bind-Value="Produto.Detalhe" />
        <ValidationMessage For="() => Produto.Detalhe" class="text-danger" />
    </div>

    <div class="mb-3">
        <label class="form-label">Origem</label>
        <InputText class="form-control" @bind-Value="Produto.Origem" />
    </div>

    <div class="mb-3">
        <label class="form-label">Preço Base</label>
        <InputNumber class="form-control" @bind-Value="Produto.PrecoBase" />
        <ValidationMessage For="() => Produto.PrecoBase" class="text-danger" />
    </div>

    <div class="mb-3">
        <label class="form-label">Margem (%)</label>
        <InputNumber class="form-control" @bind-Value="Produto.MargemPercentual" />
    </div>

    <div class="mb-3">
        <label class="form-label">Estado</label>
        <InputSelect class="form-select" @bind-Value="Produto.Estado">
            @foreach (var v in Enum.GetValues<ProdutoEstado>())
            {
                <option value="@v">@v</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label class="form-label">Stock</label>
        <InputNumber class="form-control" @bind-Value="Produto.EmStock" />
        <ValidationMessage For="() => Produto.EmStock" class="text-danger" />
    </div>

    <div class="mb-3 form-check">
        <InputCheckbox class="form-check-input" @bind-Value="Produto.ParaVenda" />
        <label class="form-check-label">Para Venda</label>
    </div>

    <div class="mb-3 form-check">
        <InputCheckbox class="form-check-input" @bind-Value="Produto.Promocao" />
        <label class="form-check-label">Promoção</label>
    </div>

    <div class="mb-3 form-check">
        <InputCheckbox class="form-check-input" @bind-Value="Produto.MaisVendido" />
        <label class="form-check-label">Mais Vendido</label>
    </div>

    <div class="mb-3">
        <label class="form-label">Categoria</label>
        <InputSelect class="form-select" @bind-Value="Produto.CategoriaId">
            <option value="0">-- Selecionar --</option>
            @foreach (var c in categorias)
            {
                <option value="@c.Id">@c.Nome</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Produto.CategoriaId" class="text-danger" />
    </div>

    <div class="mb-3">
        <label class="form-label">Modo Entrega</label>
        <InputSelect class="form-select" @bind-Value="Produto.ModoEntregaId">
            <option value="">-- (opcional) --</option>
            @foreach (var m in modos)
            {
                <option value="@m.Id">@m.Nome</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label class="form-label">Imagem</label>
        <InputFile OnChange="OnFileChange" accept=".png,.jpg,.jpeg" class="form-control" />

        @if (previewBase64 is not null)
        {
            <img class="img-thumbnail mt-2" src="@previewBase64" style="max-width:200px;max-height:200px" />
        }
        else if (Produto.Imagem is { Length: > 0 })
        {
            <img class="img-thumbnail mt-2"
                 src="@($"data:{GuessMime(Produto.Imagem)};base64,{Convert.ToBase64String(Produto.Imagem)}")"
                 style="max-width:200px;max-height:200px" />
        }
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a class="btn btn-secondary ms-2" href="/produtos">Cancelar</a>
</EditForm>

@code {
    // IMPORTANT: prevents "reset + required errors" on enhanced POST
    [SupplyParameterFromForm]
    private Produto Produto { get; set; } = new();

    private List<Categoria> categorias = new();
    private List<ModoEntrega> modos = new();
    private List<ApplicationUser> fornecedores = new();

    private string? error;
    private string? previewBase64;
    private IBrowserFile? uploadedFile;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        categorias = await db.Categorias.OrderBy(c => c.Ordem).ToListAsync();
        modos = await db.ModosEntrega.OrderBy(m => m.Nome).ToListAsync();

        fornecedores = (await UserManager.GetUsersInRoleAsync("Fornecedor"))
            .OrderBy(u => u.Nome).ThenBy(u => u.Apelido).ToList();

        if (Produto.Estado == default)
            Produto.Estado = ProdutoEstado.Pendente;

        Produto.ParaVenda = true;
    }

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        previewBase64 = null;

        const long maxBytes = 200 * 1024;

        if (uploadedFile.Size > maxBytes)
        {
            error = "Imagem demasiado grande (máx 200KB).";
            uploadedFile = null;
            return;
        }

        var ext = Path.GetExtension(uploadedFile.Name).ToLowerInvariant();
        if (ext is not ".png" and not ".jpg" and not ".jpeg")
        {
            error = "Formato inválido (apenas .png/.jpg/.jpeg).";
            uploadedFile = null;
            return;
        }

        error = null;

        await using var ms = new MemoryStream();
        await uploadedFile.OpenReadStream(maxAllowedSize: maxBytes).CopyToAsync(ms);

        var fileName = BuildTimestampedFileName(uploadedFile.Name);
        var filePath = GetImagesPath(fileName);
        Directory.CreateDirectory(Path.GetDirectoryName(filePath)!);
        await File.WriteAllBytesAsync(filePath, ms.ToArray());

        Produto.UrlImagem = fileName;
        Produto.Imagem = ms.ToArray();

        previewBase64 = $"data:{uploadedFile.ContentType};base64,{Convert.ToBase64String(Produto.Imagem)}";
    }

    private async Task AddProduto()
    {
        error = null;

        if (string.IsNullOrWhiteSpace(Produto.FornecedorId))
        {
            error = "Seleciona um fornecedor.";
            return;
        }

        if (Produto.CategoriaId <= 0)
        {
            error = "Seleciona uma categoria.";
            return;
        }

        Produto.PrecoFinal = Produto.Estado == ProdutoEstado.Activo && Produto.MargemPercentual is not null
            ? Math.Round(Produto.PrecoBase * (1 + (Produto.MargemPercentual.Value / 100m)), 2)
            : null;

        await using var db = await DbFactory.CreateDbContextAsync();
        db.Produtos.Add(Produto);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo("/produtos");
    }

    private static string GuessMime(byte[] bytes)
    {
        if (bytes.Length >= 2 && bytes[0] == 0xFF && bytes[1] == 0xD8) return "image/jpeg";
        if (bytes.Length >= 4 && bytes[0] == 0x89 && bytes[1] == 0x50 && bytes[2] == 0x4E && bytes[3] == 0x47) return "image/png";
        return "application/octet-stream";
    }

    private string GetImagesPath(string fileName)
        => Path.GetFullPath(Path.Combine(Env.ContentRootPath, "..", "..", "imgs", fileName));

    private static string BuildTimestampedFileName(string originalName)
    {
        var ext = Path.GetExtension(originalName);
        var name = Path.GetFileNameWithoutExtension(originalName);
        var timestamp = DateTimeOffset.UtcNow.ToString("yyyyMMddHHmmssfff");
        return $"{name}_{timestamp}{ext}";
    }
}

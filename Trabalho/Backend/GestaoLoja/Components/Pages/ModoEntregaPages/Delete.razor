@page "/modoentregas/delete"
@attribute [Authorize(Roles = "Admin,Gestor")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entity

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Apagar</PageTitle>

<h1>Apagar Modo de Disponibilização</h1>

@if (modoEntrega is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <p class="text-danger">Tens a certeza que queres apagar este registo?</p>

    <dl class="row">
        <dt class="col-sm-2">Nome</dt>
        <dd class="col-sm-10">@modoEntrega.Nome</dd>

        <dt class="col-sm-2">Detalhe</dt>
        <dd class="col-sm-10">@modoEntrega.Detalhe</dd>
    </dl>

    <EditForm Model="modoEntrega" OnValidSubmit="DeleteModoEntrega" FormName="deleteModoEntrega" Enhance>
        <button type="submit" class="btn btn-danger">Apagar</button>
        <a class="btn btn-secondary ms-2" href="/modoentregas">Cancelar</a>
    </EditForm>
}

@code {
    [SupplyParameterFromQuery] public int Id { get; set; }

    private ModoEntrega? modoEntrega;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        modoEntrega = await db.ModosEntrega.AsNoTracking().FirstOrDefaultAsync(m => m.Id == Id);

        if (modoEntrega is null)
            NavigationManager.NavigateTo("notfound");
    }

    private async Task DeleteModoEntrega()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var entity = await db.ModosEntrega.FirstOrDefaultAsync(m => m.Id == Id);
        if (entity is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        db.ModosEntrega.Remove(entity);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo("/modoentregas");
    }
}

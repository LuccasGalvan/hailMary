@page "/encomenda/delete"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin,Gestor")]

@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Entity
@using GestaoLoja.Entity.Enums
@using GestaoLoja.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete</PageTitle>

<h1>Delete</h1>

<p>Are you sure you want to delete this?</p>
<div>
    <h2>Encomenda</h2>
    <hr />
    @if (encomenda is null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <dl class="row">
            <dt class="col-sm-2">VendaId</dt>
            <dd class="col-sm-10">@encomenda.VendaId</dd>

            <dt class="col-sm-2">Cliente</dt>
            <dd class="col-sm-10">@clienteDisplay</dd>

            <dt class="col-sm-2">DataCriacao</dt>
            <dd class="col-sm-10">@encomenda.DataCriacao</dd>

            <dt class="col-sm-2">Estado</dt>
            <dd class="col-sm-10">@encomenda.Estado</dd>

            <dt class="col-sm-2">ValorTotal</dt>
            <dd class="col-sm-10">@encomenda.ValorTotal</dd>
        </dl>

        @if (!canDelete)
        {
            <div class="alert alert-warning">
                Esta encomenda não deve ser apagada (tem linhas e/ou já não está em PendentePagamento).
            </div>
        }

        <EditForm Model="encomenda" OnValidSubmit="DeleteEncomenda" FormName="delete" Enhance>
            <button type="submit" class="btn btn-danger" disabled="@(!canDelete)">Delete</button>
            <a class="btn btn-secondary" href="/encomenda">Cancel</a>
        </EditForm>
    }
</div>

@code {
    private Encomenda? encomenda;
    private bool canDelete;
    private string clienteDisplay = "—";

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        encomenda = await context.Encomendas
            .Include(e => e.Linhas)
            .FirstOrDefaultAsync(m => m.VendaId == Id);

        if (encomenda is null)
        {
            NavigationManager.NavigateTo("/encomenda");
            return;
        }

        var cliente = await context.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == encomenda.ClienteId);

        clienteDisplay = BuildUserDisplay(cliente, encomenda.ClienteId);

        canDelete = encomenda.Estado == EncomendaEstado.PendentePagamento
                    && (encomenda.Linhas is null || encomenda.Linhas.Count == 0);
    }

    private async Task DeleteEncomenda()
    {
        if (!canDelete)
            return;

        using var context = DbFactory.CreateDbContext();

        var existing = await context.Encomendas
            .Include(e => e.Linhas)
            .FirstOrDefaultAsync(e => e.VendaId == Id);

        if (existing is null)
        {
            NavigationManager.NavigateTo("/encomenda");
            return;
        }

        if (existing.Estado != EncomendaEstado.PendentePagamento ||
            (existing.Linhas is not null && existing.Linhas.Count > 0))
        {
            NavigationManager.NavigateTo($"/encomenda/details?id={existing.VendaId}");
            return;
        }

        context.Encomendas.Remove(existing);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/encomenda");
    }

    private static string BuildUserDisplay(ApplicationUser? user, string? fallbackId)
    {
        if (user is not null)
        {
            var fullName = $"{user.Nome} {user.Apelido}".Trim();
            if (!string.IsNullOrWhiteSpace(fullName))
                return fullName;

            if (!string.IsNullOrWhiteSpace(user.Email))
                return user.Email;
        }

        return string.IsNullOrWhiteSpace(fallbackId) ? "—" : fallbackId;
    }
}

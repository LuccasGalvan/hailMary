@page "/produtos/novo"

@using Gestao_Loja.Data
@using Gestao_Loja.Entities
@using Microsoft.EntityFrameworkCore
@using Gestao_Loja.Constants
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization

@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<h3>Novo Produto</h3>

@if (isLoading)
{
    <p>A carregar...</p>
}
else
{
    <EditForm Model="novoProduto" OnValidSubmit="CriarProdutoAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row">
            <div class="col-md-7">
                <div class="mb-3">
                    <label class="form-label">Nome</label>
                    <InputText class="form-control" @bind-Value="novoProduto.Nome" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Descrição</label>
                    <InputTextArea class="form-control" @bind-Value="novoProduto.Descricao" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Preço Base</label>
                    <InputNumber class="form-control" @bind-Value="novoProduto.PrecoBase" />
                </div>

                <div class="mb-3">
                    <label class="form-label">% Comissão</label>
                    <InputNumber class="form-control" @bind-Value="novoProduto.PercentagemComissao" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Stock</label>
                    <InputNumber class="form-control" @bind-Value="novoProduto.Stock" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <InputSelect class="form-select" @bind-Value="novoProduto.Estado">
                        @foreach (var estado in estadosProduto)
                        {
                            <option value="@estado">@estado</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Modo de Disponibilização</label>
                    <InputSelect class="form-select" @bind-Value="novoProduto.ModoDisponibilizacaoId">
                        <option value="0">-- Selecione --</option>
                        @foreach (var modo in modosDisponibilizacao)
                        {
                            <option value="@modo.ModoDisponibilizacaoId">@modo.Nome</option>
                        }
                    </InputSelect>
                </div>

                <button type="submit" class="btn btn-primary me-2">Guardar</button>
                <button type="button" class="btn btn-secondary" @onclick="Voltar">Cancelar</button>
            </div>

            <div class="col-md-5">
                <h5>Imagem</h5>

                <div class="mb-2">
                    <img src="@(string.IsNullOrWhiteSpace(CurrentImageUrl) ? "/images/no-image.png" : CurrentImageUrl)"
                         alt="Imagem do produto"
                         style="width:100%; max-width:260px; aspect-ratio: 1 / 1; object-fit: cover; border-radius:12px;"
                         onerror="this.onerror=null;this.src='/images/no-image.png';" />
                </div>

                <InputFile OnChange="OnImageSelected" accept="image/*" />

                @if (!string.IsNullOrWhiteSpace(imageError))
                {
                    <div class="text-danger mt-2">@imageError</div>
                }

                <hr />

                <h5>Categorias</h5>
                <div class="border rounded p-2" style="max-height: 250px; overflow-y: auto;">
                    @if (categorias != null && categorias.Any())
                    {
                        @foreach (var cat in categorias)
                        {
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       value="@cat.CategoriaId"
                                       checked="@selectedCategoriaIds.Contains(cat.CategoriaId)"
                                       @onchange="e => OnCategoriaCheckedChanged(e, cat.CategoriaId)" />
                                <label class="form-check-label">
                                    @cat.Nome (@cat.TipoCategoria?.Nome)
                                </label>
                            </div>
                        }
                    }
                    else
                    {
                        <p>Sem categorias definidas.</p>
                    }
                </div>
            </div>
        </div>
    </EditForm>
}

@code {
    private Produto novoProduto = new();
    private List<Categoria> categorias = new();
    private List<ModoDisponibilizacao> modosDisponibilizacao = new();
    private List<EstadoProduto> estadosProduto = Enum.GetValues<EstadoProduto>().ToList();
    private HashSet<int> selectedCategoriaIds = new();
    private bool isLoading = true;

    // Image upload
    private IBrowserFile? selectedImage;
    private string? imageError;
    private string? tempPreviewUrl;

    private string? CurrentImageUrl => tempPreviewUrl ?? novoProduto?.UrlImagem;

    protected override async Task OnInitializedAsync()
    {
        await CarregarCategoriasAsync();
        await CarregarModosAsync();
        isLoading = false;
    }

    private async Task CarregarCategoriasAsync()
    {
        categorias = await Db.Categorias
            .Include(c => c.TipoCategoria)
            .OrderBy(c => c.TipoCategoria.Nome)
            .ThenBy(c => c.Nome)
            .ToListAsync();
    }

    private async Task CarregarModosAsync()
    {
        modosDisponibilizacao = await Db.ModosDisponibilizacao
            .Where(m => m.Ativo)
            .OrderBy(m => m.Nome)
            .ToListAsync();
    }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        imageError = null;
        selectedImage = e.File;

        if (selectedImage.Size > 2 * 1024 * 1024)
        {
            imageError = "Imagem demasiado grande (máx 2MB).";
            selectedImage = null;
            tempPreviewUrl = null;
            return;
        }

        // Live preview (no DB, no disk): convert to data URL
        using var ms = new MemoryStream();
        await selectedImage.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(ms);

        var base64 = Convert.ToBase64String(ms.ToArray());
        tempPreviewUrl = $"data:{selectedImage.ContentType};base64,{base64}";
    }


    private async Task<string?> SaveImageAsync(string productName)
    {
        if (selectedImage is null)
            return null;

        var ext = Path.GetExtension(selectedImage.Name).ToLowerInvariant();
        var allowed = new[] { ".jpg", ".jpeg", ".png", ".webp" };

        if (!allowed.Contains(ext))
        {
            imageError = "Formato inválido. Use JPG, PNG ou WEBP.";
            return null;
        }

        var folder = Path.Combine(Env.WebRootPath, "images", "produtos");
        Directory.CreateDirectory(folder);

        var normalized = productName.Normalize(System.Text.NormalizationForm.FormD);
        var withoutDiacritics = new string(
            normalized.Where(ch => CharUnicodeInfo.GetUnicodeCategory(ch) != UnicodeCategory.NonSpacingMark).ToArray()
        );

        var safe = new string(withoutDiacritics
            .Replace(" ", "_")
            .Where(ch => char.IsLetterOrDigit(ch) || ch == '_' || ch == '-')
            .ToArray());

        if (string.IsNullOrWhiteSpace(safe))
            safe = "produto";

        var fileName = $"{safe}_{Guid.NewGuid():N}{ext}";
        var filePath = Path.Combine(folder, fileName);

        await using var fs = File.Create(filePath);
        await selectedImage.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(fs);

        var url = $"/images/produtos/{fileName}";
        tempPreviewUrl = url;
        return url;
    }

    private async Task CriarProdutoAsync()
    {
        if (novoProduto.ModoDisponibilizacaoId == 0)
            return;

        // if user selected an image, save it and store URL
        var newUrl = await SaveImageAsync(novoProduto.Nome);
        if (!string.IsNullOrWhiteSpace(newUrl))
            novoProduto.UrlImagem = newUrl;

        // calcular PrecoFinal
        novoProduto.PrecoFinal = novoProduto.PrecoBase +
                                 (novoProduto.PrecoBase * (novoProduto.PercentagemComissao / 100m));

        Db.Produtos.Add(novoProduto);
        await Db.SaveChangesAsync();

        if (selectedCategoriaIds.Any())
        {
            var ligacoes = selectedCategoriaIds.Select(catId => new CategoriaProduto
            {
                ProdutoId = novoProduto.ProdutoId,
                CategoriaId = catId
            });

            Db.CategoriaProdutos.AddRange(ligacoes);
            await Db.SaveChangesAsync();
        }

        Nav.NavigateTo("/produtos");
    }

    private void OnCategoriaCheckedChanged(ChangeEventArgs e, int categoriaId)
    {
        var value = e.Value?.ToString();
        var isChecked = value == "true" || value == "on";

        if (isChecked)
            selectedCategoriaIds.Add(categoriaId);
        else
            selectedCategoriaIds.Remove(categoriaId);
    }

    private void Voltar() => Nav.NavigateTo("/produtos");
}

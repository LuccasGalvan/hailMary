@page "/carrinho"
@using System
@using System.IdentityModel.Tokens.Jwt
@using System.Text.Json
@using RCLAPI.Services
@using RCLAPI.DTO
@inject IJSRuntime JSRuntime
@inject IApiServices _apiServices
@inject NavigationManager NavigationManager
@inject IAuthStorage _authStorage

<h3>Carrinho de Compras</h3>

@if (itensCarrinho == null)
{
    <p>Carregando itens do carrinho...</p>
}
else if (!itensCarrinho.Any())
{
    <p>O carrinho está vazio.</p>
}
else
{
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>Imagem</th>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Preço Total</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in itensCarrinho)
            {
                <tr>
                    <td>
                        <img src="data:image/png;base64,@Convert.ToBase64String(item.Produto.Imagem)" alt="@item.Produto.Nome" width="100" height="100" />
                    </td>
                    <td>@item.Produto.Nome</td>
                    <td>@item.Quantidade</td>
                    <td>@(item.Produto.Preco * item.Quantidade)</td>
                    <td>
                        <button class="btn btn-danger" @onclick="() => RemoverItemCarrinho(item.ProdutoId, item.Quantidade)" style="padding: 10px 20px; border-radius: 5px; cursor: pointer; background-color: red; color: white;">
                            Remover
                        </button>
                        <button class="btn btn-success" @onclick="async () => await AbrirPopUpCartao(item)" style="padding: 10px 20px; border-radius: 5px; cursor: pointer; background-color: green; color: white;">
                            Comprar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (exibirPopUpCartao)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 20px; border-radius: 10px; width: 400px;">
            <h4>Dados do Cartão</h4>
            <div>
                <label>Número do Cartão</label>
                <input type="text" @bind="numeroCartao" style="width: 100%; padding: 8px;" />
            </div>
            <div>
                <label>Validade (MM/AA)</label>
                <input type="text" @bind="validadeCartao" style="width: 100%; padding: 8px;" />
            </div>
            <div>
                <label>CVV</label>
                <input type="text" @bind="cvvCartao" style="width: 100%; padding: 8px;" />
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary" @onclick="ConfirmarCompra" style="margin-right: 10px;">Confirmar</button>
                <button class="btn btn-secondary" @onclick="CancelarPopUpCartao">Cancelar</button>
            </div>
        </div>
    </div>
}

@code {
    private List<CarOrder>? itensCarrinho;
    private bool exibirPopUpCartao = false;
    private CarOrder? itemSelecionado;
    private string numeroCartao = string.Empty;
    private string validadeCartao = string.Empty;
    private string cvvCartao = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CarregarCarrinho();
        await VerificarCheckoutPendenteAsync();
    }

    private async Task CarregarCarrinho()
    {
        var cartUserId = await GetCartUserIdAsync();

        if (string.IsNullOrEmpty(cartUserId))
        {
            Console.WriteLine("Carrinho não encontrado no Local Storage.");
            itensCarrinho = new List<CarOrder>();
            return;
        }

        itensCarrinho = await _apiServices.ObterCarrinho(cartUserId);
    }

    private async Task RemoverItemCarrinho(int itemId, int quantidade)
    {
        var cartUserId = await GetCartUserIdAsync();

        if (string.IsNullOrEmpty(cartUserId))
        {
            Console.WriteLine("Carrinho não encontrado no Local Storage.");
            return;
        }

        Console.WriteLine($"Removendo item {itemId} do carrinho...");

        var (success, message) = await _apiServices.AtualizarCarrinho(cartUserId, itemId, "remover", quantidade);

        if (success)
        {
            // Recarrega o carrinho após remoção
            await CarregarCarrinho();
        }
        else
        {
            Console.WriteLine($"Erro ao remover item do carrinho: {message}");
        }
    }

    private async Task AbrirPopUpCartao(CarOrder item)
    {
        if (!await EnsureAuthenticatedForCheckoutAsync(item))
        {
            return;
        }

        itemSelecionado = item;
        exibirPopUpCartao = true;
    }

    private void CancelarPopUpCartao()
    {
        exibirPopUpCartao = false;
        LimparDadosCartao();
        _ = LimparCheckoutPendenteAsync();
    }

    private async Task ConfirmarCompra()
    {
        if (!ValidarCartao())
        {
            Console.WriteLine("Dados do cartão inválidos.");
            return;
        }

        if (!await EnsureAuthenticatedForCheckoutAsync(itemSelecionado))
        {
            exibirPopUpCartao = false;
            LimparDadosCartao();
            return;
        }

        exibirPopUpCartao = false;

        if (itemSelecionado != null)
        {
            await ComprarProduto(itemSelecionado);
        }

        LimparDadosCartao();
    }

    private bool ValidarCartao()
    {
        return numeroCartao.Length == 16 &&
               DateTime.TryParseExact(validadeCartao, "MM/yy", null, System.Globalization.DateTimeStyles.None, out _) &&
               cvvCartao.Length == 3;
    }

    private async Task ComprarProduto(CarOrder item)
    {
        var userId = await _authStorage.GetItemAsync(AuthStorageKeys.UserId);
        if (string.IsNullOrEmpty(userId))
        {
            Console.WriteLine("Utilizador não encontrado no Local Storage.");
            return;
        }

        var checkoutResult = await _apiServices.CheckoutEncomenda(userId);
        if (checkoutResult.Data == null)
        {
            Console.WriteLine($"Erro ao fazer checkout: {checkoutResult.ErrorMessage}");
            return;
        }

        var pagamentoResult = await _apiServices.PagarEncomenda(checkoutResult.Data.Id);
        if (pagamentoResult.Data == null)
        {
            Console.WriteLine($"Erro ao pagar encomenda: {pagamentoResult.ErrorMessage}");
            return;
        }

        Console.WriteLine($"Compra do produto {item.Produto.Nome} realizada com sucesso!");
        await LimparCheckoutPendenteAsync();
        await CarregarCarrinho();
    }

    private void LimparDadosCartao()
    {
        numeroCartao = string.Empty;
        validadeCartao = string.Empty;
        cvvCartao = string.Empty;
    }

    private async Task<string> GetCartUserIdAsync()
    {
        var cartUserId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "cartUserId");
        if (!string.IsNullOrEmpty(cartUserId))
        {
            return cartUserId;
        }

        var userId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userID");
        if (!string.IsNullOrEmpty(userId))
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "cartUserId", userId);
            return userId;
        }

        var guestId = $"guest_{Guid.NewGuid()}";
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "cartUserId", guestId);
        return guestId;
    }

    private async Task GuardarCheckoutPendenteAsync(CarOrder item)
    {
        var pendingCheckout = new PendingCheckout
        {
            ProdutoId = item.ProdutoId,
            Quantidade = item.Quantidade
        };

        var payload = JsonSerializer.Serialize(pendingCheckout);
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "pendingCheckout", payload);
    }

    private async Task VerificarCheckoutPendenteAsync()
    {
        if (!await HasValidAccessTokenAsync())
        {
            return;
        }

        var payload = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "pendingCheckout");
        if (string.IsNullOrEmpty(payload))
        {
            return;
        }

        PendingCheckout? pendingCheckout;
        try
        {
            pendingCheckout = JsonSerializer.Deserialize<PendingCheckout>(payload);
        }
        catch (JsonException)
        {
            await LimparCheckoutPendenteAsync();
            return;
        }

        if (pendingCheckout == null || itensCarrinho == null)
        {
            return;
        }

        var item = itensCarrinho.FirstOrDefault(entry => entry.ProdutoId == pendingCheckout.ProdutoId);
        if (item != null)
        {
            itemSelecionado = item;
            exibirPopUpCartao = true;
        }
    }

    private async Task LimparCheckoutPendenteAsync()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "pendingCheckout");
    }

    private async Task<bool> EnsureAuthenticatedForCheckoutAsync(CarOrder? item)
    {
        if (await HasValidAccessTokenAsync())
        {
            return true;
        }

        if (item != null)
        {
            await GuardarCheckoutPendenteAsync(item);
        }

        NavigationManager.NavigateTo("/modalogin?returnUrl=/carrinho", true);
        return false;
    }

    private async Task<bool> HasValidAccessTokenAsync()
    {
        var accessToken = await _authStorage.GetItemAsync(AuthStorageKeys.AccessToken);
        return !string.IsNullOrWhiteSpace(accessToken) && !IsTokenExpired(accessToken);
    }

    private static bool IsTokenExpired(string accessToken)
    {
        var handler = new JwtSecurityTokenHandler();
        if (!handler.CanReadToken(accessToken))
        {
            return true;
        }

        var token = handler.ReadJwtToken(accessToken);
        return token.ValidTo <= DateTime.UtcNow;
    }
}

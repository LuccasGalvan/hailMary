@using RCLAPI.Services
@using RCLAPI.DTO
@inject IApiServices ApiService
@inject NavigationManager NavigationManager

<h3>Histórico de Compras</h3>

@if (!isLoggedIn)
{
    <p>Redirecionando para a página de login...</p>
}
else if (encomendas is null)
{
    <p>Carregando...</p>
}
else if (!encomendas.Any())
{
    <p>Nenhuma encomenda encontrada.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Quantidade</th>
                <th>Preço</th>
                <th>Estado</th>
                <th>Data de Criação</th>
                <th>Data de Finalização</th>
                <th>Stock</th>
                <th>Pagamento</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in PaginatedEncomendas)
            {
                <tr>
                    <td>@e.Id</td>
                    <td>@e.Quantidade</td>
                    <td>@e.Preco.ToString("C")</td>
                    <td>@e.Estado</td>
                    <td>@e.DataCriacao.ToString("dd/MM/yyyy")</td>
                    <td>@(e.DataFinalizacao?.ToString("dd/MM/yyyy") ?? "-")</td>
                    <td>
                        @if (!e.EmStock)
                        {
                            <span>Sem stock de momento – será enviada assim que possível</span>
                        }
                        else
                        {
                            <span>Em stock</span>
                        }
                    </td>
                    <td>
                        @if (!e.Paga)
                        {
                            @if (e.Estado != "Rejeitada")
                            {
                                <a href="@($"/pagaencomendas?EncomendaIdsString={e.Id}")" class="btn btn-primary">
                                    Pagar Encomenda
                                </a>
                            }
                            else
                            {
                                <span>Encomenda Rejeitada</span>
                            }
                        }
                        else
                        {
                            <span>Encomenda Paga</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="pagination-controls mt-3">
        <button class="btn btn-secondary me-2" @onclick="PrevPage" disabled="@(CurrentPage <= 1)">
            Anterior
        </button>
        <span>Página @CurrentPage de @TotalPages</span>
        <button class="btn btn-secondary ms-2" @onclick="NextPage" disabled="@(CurrentPage >= TotalPages)">
            Seguinte
        </button>

        <div class="mt-2">
            <label for="itemsPerPage">Itens por página:</label>
            <select id="itemsPerPage" @bind="ItemsPerPage">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
            </select>
        </div>
    </div>
}

@code {
    private List<EncomendaDTO>? encomendas;
    private bool isLoggedIn = false;
    private string? userId;

    // paginação simples
    private int ItemsPerPage { get; set; } = 5;
    private int CurrentPage { get; set; } = 1;

    private int TotalPages =>
        encomendas is null || encomendas.Count == 0
            ? 1
            : (int)Math.Ceiling(encomendas.Count / (double)ItemsPerPage);

    private IEnumerable<EncomendaDTO> PaginatedEncomendas =>
        encomendas is null
            ? Enumerable.Empty<EncomendaDTO>()
            : encomendas
                .Skip((CurrentPage - 1) * ItemsPerPage)
                .Take(ItemsPerPage);

    protected override async Task OnInitializedAsync()
    {
        isLoggedIn = await ApiService.IsUserLoggedIn();

        if (!isLoggedIn)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        userId = await ApiService.GetUserId();
        encomendas = await ApiService.GetEncomendasByUser();
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
        }
    }

    private void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
        }
    }
}
